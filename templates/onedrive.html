<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>OneDrive Picker Dialog (A案＋戻る修正)</title>
<style>
  :root { --brand:#0078d4; --bg:#f8f9fa; --muted:#e9ecef; --text:#222; }
  body { font-family: "Segoe UI", system-ui, -apple-system, sans-serif; background: var(--bg); margin:0; color:var(--text); }
  header { background: var(--brand); color:#fff; padding:10px 16px; display:flex; align-items:center; gap:8px; }
  header h1 { font-size:16px; margin:0; font-weight:600; }
  .toolbar { padding:8px 16px; background:#fff; border-bottom:1px solid #dde1e6; display:flex; gap:8px; align-items:center; }
  .toolbar button { border:none; border-radius:6px; padding:8px 12px; background:var(--brand); color:#fff; cursor:pointer; }
  .toolbar button.secondary { background:#e5f1fb; color:#0b5cab; }
  .toolbar button:disabled { opacity:.5; cursor:not-allowed; }
  #crumbsWrap { padding:8px 16px; background: var(--muted); border-bottom:1px solid #dde1e6; display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
  #crumbs .crumb { cursor:pointer; color: var(--brand); }
  #crumbs .crumb::after { content:" / "; color:#888; }
  #crumbs .crumb:last-child::after { content:""; }
  #searchBox { display:none; padding:8px 16px; background:#fff; border-bottom:1px solid #dde1e6; display:flex; gap:8px; }
  #searchInput { flex:1; padding:8px; border:1px solid #c8ccd1; border-radius:6px; }
  #fileList { padding:16px; display:grid; grid-template-columns: 1fr; gap:8px; }
  .file-item { padding:10px 12px; background:#fff; border:1px solid #dcdfe4; border-radius:8px; cursor:pointer; }
  .file-item:hover { background:#f4f9ff; }
  .file-item.selected { border-color: var(--brand); background:#e7f1fb; }
  footer { background:#fff; border-top:1px solid #dde1e6; padding:10px 16px; display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
  #currentPath { color:#555; font-size:12px; }
  .right { display:flex; gap:8px; }
  .hint { font-size:12px; color:#444; background:#eef5ff; padding:4px 8px; border-radius:999px; }
</style>
</head>
<body>
  <header>
    <h1>保存先を選択</h1>
  </header>

  <div class="toolbar">
    <button id="btnBack" class="secondary" title="直前に表示していた場所へ戻る">← 戻る</button>
    <button id="btnUp" class="secondary" title="親フォルダへ移動">↑ 上へ</button>
    <button id="searchToggle" class="secondary" title="フォルダ名を検索">検索</button>
  </div>

  <div id="crumbsWrap">
    <div id="crumbs"></div>
  </div>

  <div id="searchBox">
    <input id="searchInput" type="text" placeholder="フォルダ名を検索..." />
    <button id="clearSearch" class="secondary" title="検索をクリア">✕ クリア</button>
  </div>

  <div id="fileList"></div>

  <footer>
    <div>
      <div id="currentPath">ルート</div>
      <div class="hint" id="hintSaveTo">保存先：現在のフォルダ</div>
    </div>
    <div class="right">
      <button id="saveBtn">保存</button>
    </div>
  </footer>

<script>
const $ = (id) => document.getElementById(id);

// --------- 状態 ---------
let breadcrumb = [{ id: "root", name: "ルート" }]; // 仮想ルート
let currentId = "root";
let currentList = [];
let pickedFolderId = null;
let filterWord = "";
let navStack = []; // 戻る用：直前状態のスナップショットを積む
let leftVirtualRoot = false; // 仮想ルートから外へ出たか

// --------- ダミーデータ作成（実際はAPIで置き換え） ---------
function mockListFor(id) {
  // idベースで疑似的に中身を変える
  const base = id.replace(/[^A-Z0-9]/gi,"").slice(-2).toUpperCase() || "RT";
  return [
    { id: id + "-A", name: base + "_資料",  type: "folder" },
    { id: id + "-B", name: base + "_報告",  type: "folder" },
    { id: id + "-C", name: base + "_画像",  type: "folder" },
  ];
}

// --------- 共通：スナップショット ---------
function snapshot() {
  // 深いコピー（名前配列は浅いのでOK）
  return {
    currentId,
    breadcrumb: breadcrumb.map(c => ({...c})),
    filterWord,
    pickedFolderId
  };
}
function restore(state) {
  currentId = state.currentId;
  breadcrumb = state.breadcrumb.map(c => ({...c}));
  filterWord = state.filterWord;
  pickedFolderId = state.pickedFolderId;
}

// --------- ロード ---------
async function loadFolder(id, keepFilter=false, reason="") {
  currentId = id;

  // 検索語のクリア（階層移動時）
  if (!keepFilter && reason !== "reload") {
    filterWord = "";
    $("searchInput").value = "";
  }

  // 実データ取得の代わりにモック
  currentList = mockListFor(id);

  // 選択は基本クリア（誤保存防止）
  pickedFolderId = null;

  renderList();
  updateBreadcrumb();
  updateButtons();
  updateSaveHint();
}

// --------- 一段下へ（入る） ---------
function enterFolder(folder) {
  navStack.push(snapshot());
  breadcrumb.push({ id: folder.id, name: folder.name });
  loadFolder(folder.id, false, "enter");
}

// --------- 一段上へ（親へ） ---------
function goUp() {
  // 仮想ルート内にいる場合
  if (breadcrumb.length > 1) {
    navStack.push(snapshot());
    breadcrumb.pop();
    const parentId = breadcrumb[breadcrumb.length - 1].id;
    loadFolder(parentId, false, "up");
    return;
  }

  // ここから仮想ルート外へ出る
  if (!leftVirtualRoot) {
    const ok = confirm("指定されたルートの外に移動します。続行しますか？");
    if (!ok) return;
    leftVirtualRoot = true;
  }

  // ルートのさらに上＝ドライブ直下へ
  // 最上位が「ドライブ」で、それ以上は上がれない想定
  if (breadcrumb.length === 1 && breadcrumb[0].id === "root") {
    navStack.push(snapshot());
    breadcrumb = [{ id: "drive", name: "ドライブ" }];
    loadFolder("drive", false, "up-out");
  } else if (breadcrumb.length > 0 && breadcrumb[0].id === "drive") {
    // すでにドライブ直下 → これ以上は上がれない
    // 何もしない
  }
}

// --------- 直前に表示していた場所へ戻る（履歴） ---------
function goBack() {
  if (navStack.length === 0) return;
  const state = navStack.pop();
  restore(state);
  renderList();
  updateBreadcrumb();
  updateButtons();
  updateSaveHint();
}

// --------- パンくず更新（常に再計算描画、appendしない） ---------
function updateBreadcrumb() {
  const wrap = $("crumbs");
  wrap.innerHTML = "";

  breadcrumb.forEach((c, i) => {
    const s = document.createElement("span");
    s.className = "crumb";
    s.textContent = c.name;
    s.onclick = () => {
      // パンくずクリックも履歴に積む（Backで戻れるように）
      navStack.push(snapshot());
      breadcrumb = breadcrumb.slice(0, i + 1);
      loadFolder(c.id, false, "crumb");
    };
    wrap.appendChild(s);
  });

  $("currentPath").textContent = breadcrumb.map(c => c.name).join(" / ");
}

// --------- リスト描画 ---------
function renderList() {
  const list = $("fileList");
  list.innerHTML = "";

  const filtered = filterWord
    ? currentList.filter(f => f.name.includes(filterWord))
    : currentList;

  filtered.forEach(f => {
    const div = document.createElement("div");
    div.className = "file-item" + (f.id === pickedFolderId ? " selected" : "");
    div.textContent = "📂 " + f.name;

    div.onclick = (e) => {
      if (e.detail === 2) {
        // ダブルクリック：入る
        enterFolder(f);
      } else {
        // シングル：選択
        pickedFolderId = f.id;
        updateSaveHint();
        renderList();
      }
    };

    list.appendChild(div);
  });
}

// --------- ボタン状態 ---------
function updateButtons() {
  // 戻る：履歴が空なら無効
  $("btnBack").disabled = navStack.length === 0;

  // 上へ：ドライブが先頭なら無効、それ以外は有効
  const atDriveTop = (breadcrumb.length === 1 && breadcrumb[0].id === "drive");
  $("btnUp").disabled = atDriveTop;
}

// --------- 検索 UI ---------
$("searchToggle").onclick = () => {
  const box = $("searchBox");
  const isOpen = box.style.display === "flex";
  box.style.display = isOpen ? "none" : "flex";
  if (!isOpen) $("searchInput").focus();
};
$("searchInput").oninput = (e) => {
  filterWord = e.target.value;
  renderList();
};
$("clearSearch").onclick = () => {
  filterWord = "";
  $("searchInput").value = "";
  renderList();
};

// --------- 保存 ---------
$("saveBtn").onclick = () => {
  const folderId = pickedFolderId || currentId;
  const folderName = pickedFolderId
    ? (currentList.find(f => f.id === pickedFolderId)?.name || "(不明)")
    : breadcrumb[breadcrumb.length - 1].name;
  alert(`フォルダ『${folderName}』に保存します (id=${folderId})`);
};

function updateSaveHint() {
  const hint = $("hintSaveTo");
  if (pickedFolderId) {
    const name = currentList.find(f => f.id === pickedFolderId)?.name || "(不明)";
    hint.textContent = `保存先：${name}（選択フォルダ）`;
  } else {
    hint.textContent = `保存先：${breadcrumb[breadcrumb.length - 1].name}（現在のフォルダ）`;
  }
}

// --------- イベント割り当て ---------
$("btnUp").onclick = goUp;
$("btnBack").onclick = goBack;

// --------- 初期化 ---------
loadFolder("root", true, "init");
</script>
</body>
</html>
