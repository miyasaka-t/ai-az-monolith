<!doctype html>
<meta charset="utf-8" />
<title>OneDrive 保存（組織専用ピッカー + 新規フォルダ）</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{ --fg:#1f2937; --muted:#6b7280; --line:#e5e7eb; --bg:#fff; --primary:#0b5; }
  body{font:13px/1.5 ui-sans-serif,system-ui,Segoe UI,Helvetica,Arial;
       color:var(--fg); max-width:900px; margin:20px auto; padding:0 10px;}
  h1{font-size:18px;margin:0 0 8px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0}
  .col{display:flex;flex-direction:column;gap:4px;min-width:260px;flex:1}
  label.small{font-size:12px;color:var(--muted)}
  input[type=text]{flex:1;min-width:240px;padding:6px 8px;border:1px solid var(--line);border-radius:8px}
  button{padding:8px 10px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer}
  button:disabled{opacity:.55;cursor:not-allowed}
  .pill{padding:4px 8px;border:1px solid #e8e8ff;background:#f7f7ff;border-radius:999px}
  .badge{padding:2px 8px;border-radius:999px;background:#eef;color:#224;font-weight:600}
  .muted{color:var(--muted)}
  #log{white-space:pre-wrap;background:#fafafa;border:1px solid #eee;padding:10px;min-height:120px}

  /* ピッカー */
  .picker-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:9999}
  .picker-panel{width:min(560px,92vw);background:var(--bg);border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,.20);overflow:hidden}
  .picker-head{display:flex;align-items:center;gap:6px;padding:8px 10px;border-bottom:1px solid var(--line)}
  .picker-title{font-weight:700;margin-right:auto}
  .picker-toolbar{display:flex;gap:6px}
  .picker-body{padding:0;max-height:60vh;overflow:auto}
  .picker-breadcrumb{display:flex;gap:4px;align-items:center;flex-wrap:wrap;padding:6px 10px;border-bottom:1px solid var(--line);background:#fafafa}
  .crumb{color:#2563eb;cursor:pointer}
  .crumb::after{content:"›";margin:0 4px;color:#9ca3af}
  .crumb:last-child{font-weight:700;color:var(--fg)}
  .crumb:last-child::after{content:""}
  .list{width:100%;padding:8px}
  .th,.tr{display:grid;grid-template-columns: 1fr 168px;gap:8px;align-items:center}
  .th{padding:0 6px 6px;color:var(--muted);font-weight:600;border-bottom:1px solid var(--line)}
  .tr{padding:2px 6px}
  .rowbox{display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:10px;padding:6px 8px;min-height:34px}
  .tr:hover .rowbox{background:#f8faff}
  .name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .act{display:inline-flex;gap:6px;justify-content:flex-end;align-items:center}
  .act > button{padding:6px 8px;line-height:1;border-radius:8px}
  .ok{background:var(--primary);color:#fff;border-color:var(--primary)}
  .picker-foot{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-top:1px solid var(--line)}
  .path{font-family:ui-monospace,Menlo,Consolas,monospace;color:#555;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:62%}

  /* ✅ 縦並び用 */
  .vertical{flex-direction:column;align-items:flex-start;gap:8px}
  .chk{display:flex;align-items:center;gap:8px}

   /* ✅ 親へボタン非表示 */
  #btnUp { display: none !important; }

    /* 強制付与ヒントをUIから隠す */
  #nm_eml_hint, #nm_xlsx_hint { display: none !important; }
  
</style>

<h1>OneDrive 保存 <span class="badge">組織モード</span></h1>
<p class="muted">Graph API（アプリ権限）で保存。フォルダは自前ピッカー。</p>

<!-- ✅ 新UI：ベース名だけ入力。拡張子は自動付与（縦並び） -->
<div class="row vertical">
  <div class="col">
    <label class="small">AI作成本文（.eml）のベース名</label>
    <input id="emlBase" type="text" placeholder="Report">
    <div class="muted" id="nm_eml_hint"></div>
  </div>
  <div class="col">
    <label class="small">添付Excelのベース名（拡張子は添付のオリジナルを強制付与）</label>
    <input id="xlsxBase" type="text" placeholder="SkillSheet">
    <div class="muted" id="nm_xlsx_hint"></div>
  </div>
</div>

<!-- ✅ 保存内容チェックボックス（縦並び） -->
<div class="row vertical">
  <div class="chk">
    <label><input type="checkbox" id="cb_eml"> AI作成本文.eml</label>
    <span id="nm_eml" class="muted"></span>
  </div>
  <div class="chk">
    <label><input type="checkbox" id="cb_xlsx"> 添付Excelスキルシート</label>
    <span id="nm_xlsx" class="muted"></span>
  </div>
  <div class="chk">
    <label><input type="checkbox" id="cb_msg"> BPさんからのメール.msg</label>
    <span id="nm_msg" class="muted"></span>
  </div>
</div>

<div id="orgPanel">
  <div class="row">
    <button id="pickLocal">📁 保存先フォルダを選ぶ</button>
    <span id="pickedHint" class="pill"></span>
  </div>
  <div class="row"><button id="upload" disabled>⬆ アップロード実行</button></div>
</div>

<h3>ログ</h3>
<pre id="log"></pre>

<!-- 以降：自前フォルダピッカー（既存） -->
<div id="picker" class="picker-backdrop" style="display:none" role="dialog" aria-modal="true">
  <div class="picker-panel">
    <div class="picker-head">
      <div class="picker-title">保存先を選択</div>
      <div class="picker-toolbar">
        <button id="btnBack">← 戻る</button>
        <button id="btnUp">↑ 親へ</button>
        <button id="btnNewFolder">＋ 新規フォルダ</button>
        <button id="btnReload">⟳ 更新</button>
      </div>
    </div>
    <div class="picker-breadcrumb" id="crumbs"></div>
    <div class="picker-body">
      <div class="th"><div>名前</div><div style="text-align:right">操作</div></div>
      <div id="list" class="list"></div>
    </div>
    <div class="picker-foot">
      <div class="path" id="currentPath">/</div>
      <div>
        <button id="pickerCancel">キャンセル</button>
        <button id="pickerOk" class="ok" disabled>このフォルダを選択</button>
      </div>
    </div>
  </div>
</div>

<script>
const $ = (id)=>document.getElementById(id);
const log = (m)=>{ $("log").textContent += m + "\n"; };

// ===== クエリ初期化 =====
// 例: /front?ticket_eml=...&ticket_msg=...&eml=見積提案&excel=候補者A_スキル
const q = new URLSearchParams(location.search);
const T_EML   = q.get("ticket_eml")   || "";
const T_XLSX  = q.get("ticket_xlsx")  || ""; // 別途来る運用も想定（任意）
const T_MSG   = q.get("ticket_msg")   || "";
const TICKET_SINGLE = q.get("ticket") || ""; // 単体チケット運用も一応維持

// ✅ ベース名の初期表示（拡張子なし想定）
const EML_BASE_INIT  = (q.get("eml")   || "Report").trim();
const XLSX_BASE_INIT = (q.get("excel") || "SkillSheet").trim();
$("emlBase").value  = EML_BASE_INIT;
$("xlsxBase").value = XLSX_BASE_INIT;

const EP_PEEK             = "/tickets/peek";
const EP_UPLOAD_ORG       = "/api/upload";
const EP_LIST_FOLDERS     = "/api/drive/folders";
const EP_CREATE_FOLDER    = "/api/drive/create-folder";
const EP_CREATE_FOLDER_ALT= "/api/drive/createFolder";
const EP_MSG_TO_XLSX_TID  = "/api/msg-to-xlsx-ticket";

// --- 初期表示（どのチケットが来てるか）
(async function initPeek(){
  try {
    if (T_EML || TICKET_SINGLE){ $("cb_eml").checked = true; $("nm_eml").textContent = "ticket ready"; }
    if (T_XLSX){ $("cb_xlsx").checked = true; $("nm_xlsx").textContent = "ticket ready"; }
    if (T_MSG){ $("cb_msg").checked = true; $("nm_msg").textContent = "ticket ready"; }
    $("nm_eml_hint").textContent  = "保存時は「" + $("emlBase").value + ".eml」を強制付与";
    $("nm_xlsx_hint").textContent = "保存時は「" + $("xlsxBase").value + " + 添付の拡張子」を強制付与";
  } catch(e){ log("peek error: "+e.message); }
})();

// ===== フォルダピッカー（既存） =====
let pickedFolderId=null,pickedFolderName=null,currentId="root",historyStack=[],breadcrumb=[{id:"root",name:"ルート"}];

function openPicker(){ pickedFolderId=null;pickedFolderName=null;$("pickerOk").disabled=true;$("picker").style.display="flex";historyStack=[];breadcrumb=[{id:"root",name:"ルート"}];loadFolder("root",false,"open");}
function closePicker(){ $("picker").style.display="none"; }

async function loadFolder(id,pushHistory=true,from="enter"){
  $("list").innerHTML="";$("pickerOk").disabled=true;
  try{
    const r=await fetch(EP_LIST_FOLDERS+"?parentId="+encodeURIComponent(id||"root"));
    const j=await r.json();
    if(!r.ok) throw new Error(j.error||r.statusText);
    if(pushHistory&&currentId&&from!=="back") historyStack.push(currentId);
    currentId=id||"root";updateBreadcrumb(j.parent,id);renderList(j.folders||[]);
    $("currentPath").textContent=breadcrumb.map(c=>c.name).join("/")||"/";
  }catch(e){ log("❌ folder load: "+e.message); }
}
function updateBreadcrumb(parentMeta,id){
  if((id||"root")==="root") breadcrumb=[{id:"root",name:"ルート"}];
  else{breadcrumb.push({id,name:(parentMeta&&parentMeta.name)||"(不明)"});}
  $("crumbs").innerHTML="";
  breadcrumb.forEach((c,i)=>{
    const s=document.createElement("span");
    s.className="crumb"; s.textContent=c.name;
    s.onclick=()=>{breadcrumb=breadcrumb.slice(0,i+1);loadFolder(c.id,false,"crumb");};
    $("crumbs").appendChild(s);
  });
}
function renderList(folders){
  const list=$("list");
  if(!folders.length){list.innerHTML="<div style='padding:10px'>（空）</div>";return;}
  folders.forEach(f=>{
    const row=document.createElement("div");row.className="tr";
    const left=document.createElement("div");left.className="rowbox";left.textContent="📁 "+f.name;left.ondblclick=()=>enterFolder(f.id,f.name);
    const right=document.createElement("div");right.className="act";
    const bOpen=document.createElement("button");bOpen.textContent="開く";bOpen.onclick=()=>enterFolder(f.id,f.name);
    const bChoose=document.createElement("button");bChoose.textContent="ここに保存";bChoose.onclick=()=>chooseHere(f.id,f.name);
    right.appendChild(bOpen);right.appendChild(bChoose);
    row.appendChild(left);row.appendChild(right);list.appendChild(row);
  });
}
function enterFolder(id,name){breadcrumb.push({id,name});loadFolder(id,true,"enter");}
function chooseHere(id,name){pickedFolderId=id;pickedFolderName=name;$("pickerOk").disabled=false;$("currentPath").textContent=breadcrumb.map(c=>c.name).join("/")+"/"+name;}

$("btnBack").onclick=()=>{if(!historyStack.length)return;const prev=historyStack.pop();loadFolder(prev,false,"back");};
$("btnUp").onclick=()=>{if(breadcrumb.length<=1)return;breadcrumb.pop();loadFolder(breadcrumb[breadcrumb.length-1].id,false,"up");};
$("btnReload").onclick=()=>loadFolder(currentId,false,"reload");

// 新規フォルダ
async function createFolderCall(url,parentId,name){
  const body={parentId:parentId||"root",name:(name||"").trim(),conflictBehavior:"rename"};
  const r=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
  const txt=await r.text();let j;try{j=JSON.parse(txt);}catch{j={raw:txt};}
  log(`POST ${url} → ${r.status}\nreq=${JSON.stringify(body)}\nres=${txt.substring(0,200)}`);
  return{ok:r.ok,status:r.status,json:j};
}
$("btnNewFolder").onclick=async()=>{
  const base=prompt("新しいフォルダ名?","");if(!base)return;const name=base.trim();if(!name)return;
  const pid=(!currentId||currentId==="undefined"||currentId==="null")?"root":currentId;
  let res=await createFolderCall(EP_CREATE_FOLDER,pid,name);
  if(res.status===404){res=await createFolderCall(EP_CREATE_FOLDER_ALT,pid,name);}
  if(res.ok){log(`📁 作成: ${res.json.name}`);await loadFolder(pid,false,"created");}
  else{alert("作成失敗: "+res.status);}
};

$("pickerCancel").onclick=closePicker;
$("pickerOk").onclick=()=>{if(!pickedFolderId)return;$("pickedHint").textContent="選択中: "+(pickedFolderName||pickedFolderId);$("upload").disabled=false;closePicker();};

// ===== APIユーティリティ =====
async function uploadOne(endpoint,ticket,nameOverride){
  const fd=new FormData();
  fd.append("ticket",ticket);
  fd.append("folderId",pickedFolderId);
  if(nameOverride) fd.append("fileName",nameOverride);
  const r=await fetch(endpoint,{method:"POST",body:fd});
  const j=await r.json().catch(()=>({}));
  return{ok:r.ok,status:r.status,body:j};
}

// .msg → xlsx チケット化（元の拡張子も得る）
async function createXlsxTicketFromMsg(msgTicket){
  const body = { ticket: msgTicket }; // fileName は渡さない：まずオリジナル名を知る
  const r = await fetch(EP_MSG_TO_XLSX_TID, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });
  const j = await r.json().catch(()=>({}));
  if (!r.ok || !j.ok) {
    throw new Error("msg-to-xlsx-ticket failed: "+JSON.stringify(j));
  }
  return j; // { ok, ticket, fileName }
}

// ===== アップロード実行 =====
$("pickLocal").onclick=openPicker;
$("upload").onclick=async()=>{
  if(!pickedFolderId){alert("フォルダ選んで");return;}

  const want_eml  = $("cb_eml").checked  && (T_EML || TICKET_SINGLE);
  const want_xlsx = $("cb_xlsx").checked && (T_MSG || T_XLSX); // 原則 .msg から抽出
  const want_msg  = $("cb_msg").checked  && T_MSG;

  if(!want_eml && !want_xlsx && !want_msg){alert("保存項目チェックを");return;}

  // 入力されたベース名
  const emlBase  = ($("emlBase").value  || "Report").trim();
  const xlsxBase = ($("xlsxBase").value || "SkillSheet").trim();

  // .eml の最終名（.emlを強制付与）
  const emlName = emlBase ? (emlBase.toLowerCase().endsWith(".eml") ? emlBase : emlBase + ".eml") : "Report.eml";

  $("upload").disabled = true;
  try {
    let xlsxTicket = null;
    let xlsxOrigFileName = null;
    // 1) 先に xlsx 用の非消費チケット化（オリジナル拡張子を知る）
    if (want_xlsx) {
      if (T_MSG) {
        log("→ msg-to-xlsx-ticket");
        const j = await createXlsxTicketFromMsg(T_MSG);
        xlsxTicket = j.ticket;
        xlsxOrigFileName = (j.fileName || "").trim();
        log("xlsx ticket ok: " + xlsxOrigFileName);
      } else if (T_XLSX) {
        // すでに xlsx チケットが来ている運用も一応サポート
        xlsxTicket = T_XLSX;
        xlsxOrigFileName = "attachment.xlsx";
      }
    }

    // 2) eml をアップ（任意）— ベース名 + .eml を強制適用
    if (want_eml) {
      const t = T_EML || TICKET_SINGLE;
      log("→ eml upload as: " + emlName);
      const r = await uploadOne(EP_UPLOAD_ORG, t, emlName);
      log(r.ok ? "✅ AI作成本文保存成功" : "❌ eml " + JSON.stringify(r.body));
    }

    // 3) msg 原文をアップ（任意／ここで初めて消費）
    if (want_msg) {
      log("→ msg upload (original name)");
      const r = await uploadOne(EP_UPLOAD_ORG, T_MSG, null);
      log(r.ok ? "✅ BPさんからのメール保存成功" : "❌ msg " + JSON.stringify(r.body));
    }

    // 4) xlsx をアップ（任意）— ベース名 + “オリジナル拡張子” を強制適用
    if (want_xlsx && xlsxTicket) {
      // オリジナルの拡張子を抽出（.xlsx / .xlsm / .xls / .csv など）
      let ext = ".xlsx";
      if (xlsxOrigFileName && xlsxOrigFileName.includes(".")) {
        const i = xlsxOrigFileName.lastIndexOf(".");
        ext = xlsxOrigFileName.slice(i);
      }
      const xlsxFinalName = (xlsxBase || "SkillSheet") + ext;
      log("→ xlsx upload as: " + xlsxFinalName);
      const r = await uploadOne(EP_UPLOAD_ORG, xlsxTicket, xlsxFinalName);
      log(r.ok ? "✅ 添付Excelスキルシート保存成功" : "❌ xlsx " + JSON.stringify(r.body));
    }
  } catch (e) {
    log("❌ " + e.message);
  } finally {
    $("upload").disabled = false;
  }
};
</script>
