<!doctype html>
<meta charset="utf-8" />
<title>OneDrive ä¿å­˜ï¼ˆçµ„ç¹”å°‚ç”¨ãƒ”ãƒƒã‚«ãƒ¼ + æ–°è¦ãƒ•ã‚©ãƒ«ãƒ€ï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="data:,">
<style>
  :root{ --fg:#1f2937; --muted:#6b7280; --line:#e5e7eb; --bg:#fff; --primary:#0b5; --sel:#e6f3ff; --selborder:#9cc7ff; }
  body{font:13px/1.5 ui-sans-serif,system-ui,Segoe UI,Helvetica,Arial;
       color:var(--fg); max-width:900px; margin:20px auto; padding:0 10px;}
  h1{font-size:18px;margin:0 0 8px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0}
  .col{display:flex;flex-direction:column;gap:4px;min-width:260px;flex:1}
  label.small{font-size:12px;color:var(--muted)}
  input[type=text]{flex:1;min-width:240px;padding:6px 8px;border:1px solid var(--line);border-radius:8px}
  button{padding:8px 10px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer}
  button:disabled{opacity:.55;cursor:not-allowed}
  .pill{padding:4px 8px;border:1px solid #e8e8ff;background:#f7f7ff;border-radius:999px}
  .badge{padding:2px 8px;border-radius:999px;background:#eef;color:#224;font-weight:600}
  .muted{color:var(--muted)}
  #log{white-space:pre-wrap;background:#fafafa;border:1px solid #eee;padding:10px;min-height:120px}

  /* ãƒ”ãƒƒã‚«ãƒ¼ */
  .picker-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:9999}
  .picker-panel{width:min(560px,92vw);background:var(--bg);border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,.20);overflow:hidden}
  .picker-head{display:flex;align-items:center;gap:6px;padding:8px 10px;border-bottom:1px solid var(--line)}
  .picker-title{font-weight:700;margin-right:auto}
  .picker-toolbar{display:flex;gap:6px}
  .picker-body{padding:0;max-height:60vh;overflow:auto}
  .picker-breadcrumb{display:flex;gap:4px;align-items:center;flex-wrap:wrap;padding:6px 10px;border-bottom:1px solid var(--line);background:#fafafa}
  .crumb{color:#2563eb;cursor:pointer}
  .crumb::after{content:"â€º";margin:0 4px;color:#9ca3af}
  .crumb:last-child{font-weight:700;color:var(--fg)}
  .crumb:last-child::after{content:""}
  .list{width:100%;padding:8px}
  .th,.tr{display:grid;grid-template-columns: 1fr 168px;gap:8px;align-items:center}
  .th{padding:0 6px 6px;color:var(--muted);font-weight:600;border-bottom:1px solid var(--line)}
  .tr{padding:2px 6px}
  .rowbox{display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:10px;padding:6px 8px;min-height:34px}
  .tr:hover .rowbox{background:#f8faff}
  .rowbox.selected{ background: var(--sel); border-color: var(--selborder); }
  .name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .act{display:inline-flex;gap:6px;justify-content:flex-end;align-items:center}
  .act > button{padding:6px 8px;line-height:1;border-radius:8px}
  .ok{background:var(--primary);color:#fff;border-color: var(--primary)}
  .picker-foot{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-top:1px solid var(--line)}
  .path{font-family:ui-monospace,Menlo,Consolas,monospace;color:#555;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:62%}

  /* ç¸¦ä¸¦ã³ */
  .vertical{flex-direction:column;align-items:flex-start;gap:8px}

  /* è¦ªã¸ãƒœã‚¿ãƒ³éè¡¨ç¤ºï¼ˆæ—¢å­˜ç¶­æŒï¼‰ */
  #btnUp { display: none !important; }

  /* å¼·åˆ¶ä»˜ä¸ãƒ’ãƒ³ãƒˆã‚’UIã‹ã‚‰éš ã™ï¼ˆæ—¢å­˜ç¶­æŒï¼‰ */
  #nm_eml_hint, #nm_xlsx_hint { display: none !important; }
</style>

<h1>OneDrive ä¿å­˜ <span class="badge">çµ„ç¹”ãƒ¢ãƒ¼ãƒ‰</span></h1>
<p class="muted">Graph APIï¼ˆã‚¢ãƒ—ãƒªæ¨©é™ï¼‰ã§ä¿å­˜ã€‚ãƒ•ã‚©ãƒ«ãƒ€ã¯è‡ªå‰ãƒ”ãƒƒã‚«ãƒ¼ã€‚</p>

<!-- ãƒ™ãƒ¼ã‚¹åå…¥åŠ› -->
<div class="row vertical">
  <div class="col">
    <label class="small">AIä½œæˆæœ¬æ–‡ï¼ˆ.emlï¼‰ã®ãƒ™ãƒ¼ã‚¹å</label>
    <input id="emlBase" type="text" placeholder="Report">
    <div class="muted" id="nm_eml_hint"></div>
  </div>
  <div class="col">
    <label class="small">æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ™ãƒ¼ã‚¹åï¼ˆæ‹¡å¼µå­ã¯æ·»ä»˜ã®ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚’å¼·åˆ¶ä»˜ä¸ï¼‰</label>
    <input id="xlsxBase" type="text" placeholder="Attachment">
    <div class="muted" id="nm_xlsx_hint"></div>
  </div>
</div>

<!-- æ“ä½œ -->
<div class="row">
  <button id="openPicker">ğŸ“ ä¿å­˜å…ˆã‚’é¸ã¶</button>
  <span id="pickedHint" class="pill"></span>
</div>

<h3>ãƒ­ã‚°</h3>
<pre id="log"></pre>

<!-- è‡ªå‰ãƒ•ã‚©ãƒ«ãƒ€ãƒ”ãƒƒã‚«ãƒ¼ -->
<div id="picker" class="picker-backdrop" style="display:none" role="dialog" aria-modal="true">
  <div class="picker-panel">
    <div class="picker-head">
      <div class="picker-title">ä¿å­˜å…ˆã‚’é¸æŠ</div>
      <div class="picker-toolbar">
        <button id="btnBack">â† æˆ»ã‚‹</button>
        <button id="btnUp">â†‘ è¦ªã¸</button>
        <button id="btnNewFolder">ï¼‹ æ–°è¦ãƒ•ã‚©ãƒ«ãƒ€</button>
        <button id="btnReload">âŸ³ æ›´æ–°</button>
      </div>
    </div>
    <div class="picker-breadcrumb" id="crumbs"></div>
    <div class="picker-body">
      <div class="th"><div>åå‰</div><div style="text-align:right">æ“ä½œ</div></div>
      <div id="list" class="list"></div>
    </div>
    <div class="picker-foot">
      <div class="path" id="currentPath">/</div>
      <div>
        <button id="pickerCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="pickerSave" class="ok" disabled>ä¿å­˜</button>
      </div>
    </div>
  </div>
</div>

<script>
const $ = (id)=>document.getElementById(id);
const log = (m)=>{ $("log").textContent += m + "\\n"; };

// ===== ã‚¯ã‚¨ãƒªåˆæœŸåŒ– =====
const q = new URLSearchParams(location.search);
const T_EML   = q.get("ticket_eml")   || "";
const T_XLSX  = q.get("ticket_xlsx")  || "";
const T_MSG   = q.get("ticket_msg")   || "";
const TICKET_SINGLE = q.get("ticket") || "";

// ãƒ™ãƒ¼ã‚¹ååˆæœŸå€¤
const EML_BASE_INIT  = (q.get("eml")   || "Report").trim();
const XLSX_BASE_INIT = (q.get("excel") || q.get("attach") || "Attachment").trim();
$("emlBase").value  = EML_BASE_INIT;
$("xlsxBase").value = XLSX_BASE_INIT;

// ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
const EP_PEEK             = "/tickets/peek";
const EP_UPLOAD_ORG       = "/api/upload";
const EP_LIST_FOLDERS     = "/api/drive/folders";
const EP_CREATE_FOLDER    = "/api/drive/create-folder";
const EP_CREATE_FOLDER_ALT= "/api/drive/createFolder";
const EP_MSG_TO_XLSX_TID  = "/api/msg-to-xlsx-ticket";
const EP_MSG_TO_ANY_TID   = "/api/msg-to-attachment-ticket"; // è¿½åŠ 
const EP_DELETE_FOLDER    = "/api/drive/delete-folder";

// === è¿½åŠ ï¼ˆupload-from-urlï¼‰===
const EP_UPLOAD_FROM_URL  = "/api/upload-from-url";
const GITHUB_RAW_URL   = "https://github.com/miyasaka-t/macros/raw/refs/heads/main/%E5%8D%B0%E5%88%B7_%E3%83%97%E3%83%AD%E3%83%91%E3%83%86%E3%82%A3%E3%83%BC_%E3%83%9E%E3%82%AF%E3%83%AD.xlsm";
const GITHUB_SAVE_NAME = "å°åˆ·_ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ¼ãƒã‚¯ãƒ­.xlsm";
// ============================

// åˆæœŸãƒ’ãƒ³ãƒˆ
(function initHints(){
  $("nm_eml_hint").textContent  = "ä¿å­˜æ™‚ã¯ã€Œ" + $("emlBase").value + ".emlã€ã‚’å¼·åˆ¶ä»˜ä¸";
  $("nm_xlsx_hint").textContent = "ä¿å­˜æ™‚ã¯ã€Œ" + $("xlsxBase").value + " + æ·»ä»˜ã®æ‹¡å¼µå­ã€ã‚’å¼·åˆ¶ä»˜ä¸";
})();

// ===== ãƒ•ã‚©ãƒ«ãƒ€ãƒ”ãƒƒã‚«ãƒ¼ =====
let pickedFolderId=null,pickedFolderName=null,currentId="root",historyStack=[],breadcrumb=[{id:"root",name:"ãƒ«ãƒ¼ãƒˆ"}];
let selectedRowEl = null;

function openPicker(){
  pickedFolderId=null; pickedFolderName=null;
  $("pickerSave").disabled=true;
  $("picker").style.display="flex";
  historyStack=[]; breadcrumb=[{id:"root",name:"ãƒ«ãƒ¼ãƒˆ"}];
  loadFolder("root",false,"open");
}
function closePicker(){ $("picker").style.display="none"; }

async function loadFolder(id,pushHistory=true,from="enter"){
  $("list").innerHTML=""; $("pickerSave").disabled=true;
  selectedRowEl = null;
  try{
    const r=await fetch(EP_LIST_FOLDERS+"?parentId="+encodeURIComponent(id||"root"));
    const j=await r.json();
    if(!r.ok) throw new Error(j.error||r.statusText);
    if(pushHistory&&currentId&&from!=="back") historyStack.push(currentId);
    currentId=id||"root"; updateBreadcrumb(j.parent,id); renderList(j.folders||[]);
    $("currentPath").textContent=breadcrumb.map(c=>c.name).join("/")||"/";
  }catch(e){ log("âŒ folder load: "+e.message); }
}
function updateBreadcrumb(parentMeta,id){
  if((id||"root")==="root") breadcrumb=[{id:"root",name:"ãƒ«ãƒ¼ãƒˆ"}];
  else { breadcrumb.push({id,name:(parentMeta&&parentMeta.name)||"(ä¸æ˜)"}); }
  $("crumbs").innerHTML="";
  breadcrumb.forEach((c,i)=>{
    const s=document.createElement("span");
    s.className="crumb"; s.textContent=c.name;
    s.onclick=()=>{ breadcrumb=breadcrumb.slice(0,i+1); loadFolder(c.id,false,"crumb"); };
    $("crumbs").appendChild(s);
  });
}
function renderList(folders){
  const list=$("list");
  if(!folders.length){ list.innerHTML="<div style='padding:10px'>ï¼ˆç©ºï¼‰</div>"; return; }
  folders.forEach(f=>{
    const row=document.createElement("div"); row.className="tr";
    const left=document.createElement("div"); left.className="rowbox name"; left.textContent="ğŸ“ "+f.name;
    left.onclick=()=>{
      if(selectedRowEl) selectedRowEl.classList.remove("selected");
      left.classList.add("selected");
      selectedRowEl = left;
      pickedFolderId = f.id;
      pickedFolderName = f.name;
      $("pickerSave").disabled=false;
      $("currentPath").textContent=breadcrumb.map(c=>c.name).join("/")+"/"+f.name;
    };
    left.ondblclick = () => enterFolder(f.id,f.name);

    const right=document.createElement("div"); right.className="act";
    const bOpen=document.createElement("button"); bOpen.textContent="é–‹ã"; bOpen.onclick=()=>enterFolder(f.id,f.name);
    const bDel=document.createElement("button"); bDel.textContent="å‰Šé™¤"; bDel.onclick=()=>deleteFolder(f.id,f.name);
    right.appendChild(bOpen); right.appendChild(bDel);

    row.appendChild(left); row.appendChild(right);
    list.appendChild(row);
  });
}
function enterFolder(id,name){ breadcrumb.push({id,name}); loadFolder(id,true,"enter"); }

async function deleteFolder(id,name){
  if(!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
  try{
    const r = await fetch(EP_DELETE_FOLDER, { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ id }) });
    const j = await r.json().catch(()=>({}));
    if(!r.ok || j.ok !== true){ throw new Error((j && (j.detail||j.error)) || r.statusText); }
    log(`ğŸ—‘ï¸ å‰Šé™¤: ${name}`);
    await loadFolder(currentId,false,"delete");
  }catch(e){
    alert("å‰Šé™¤å¤±æ•—: " + e.message);
  }
}

$("btnBack").onclick=()=>{ if(!historyStack.length) return; const prev=historyStack.pop(); loadFolder(prev,false,"back"); };
$("btnUp").onclick=()=>{ if(breadcrumb.length<=1) return; breadcrumb.pop(); loadFolder(breadcrumb[breadcrumb.length-1].id,false,"up"); };
$("btnReload").onclick=()=>loadFolder(currentId,false,"reload");

// æ–°è¦ãƒ•ã‚©ãƒ«ãƒ€
async function createFolderCall(url,parentId,name){
  const body={parentId:parentId||"root",name:(name||"").trim(),conflictBehavior:"rename"};
  const r=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
  const txt=await r.text(); let j; try{ j=JSON.parse(txt);}catch{ j={raw:txt}; }
  log(`POST ${url} â†’ ${r.status}\\nreq=${JSON.stringify(body)}\\nres=${txt.substring(0,200)}`);
  return { ok:r.ok, status:r.status, json:j };
}
$("btnNewFolder").onclick=async()=>{
  const base=prompt("æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€å?",""); if(!base) return; const name=base.trim(); if(!name) return;
  const pid=(!currentId||currentId==="undefined"||currentId==="null")?"root":currentId;
  let res=await createFolderCall(EP_CREATE_FOLDER,pid,name);
  if(res.status===404){ res=await createFolderCall(EP_CREATE_FOLDER_ALT,pid,name); }
  if(res.ok){ log(`ğŸ“ ä½œæˆ: ${res.json.name}`); await loadFolder(pid,false,"created"); }
  else { alert("ä½œæˆå¤±æ•—: "+res.status); }
};

$("pickerCancel").onclick=closePicker;

// ===== APIãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
async function uploadOne(endpoint,ticket,nameOverride){
  const fd=new FormData();
  fd.append("ticket",ticket);
  fd.append("folderId",pickedFolderId);
  if(nameOverride) fd.append("fileName",nameOverride);
  const r=await fetch(endpoint,{method:"POST",body:fd});
  const j=await r.json().catch(()=>({}));
  return { ok:r.ok, status:r.status, body:j };
}

// .msg / .eml â†’ Excel/PDF/Word ã„ãšã‚Œã‹ã®æœ€åˆã®æ·»ä»˜ã‚’ãƒã‚±ãƒƒãƒˆåŒ–
async function createAttachmentTicketFromMsg(msgTicket, fileNameBase){
  const body = { ticket: msgTicket, fileName: fileNameBase || "Attachment" };
  const r = await fetch(EP_MSG_TO_ANY_TID, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });
  const j = await r.json().catch(()=>({}));
  if (!r.ok || !j.ok) throw new Error("msg-to-attachment-ticket failed: "+JSON.stringify(j));
  return j; // { ok, ticket, fileName, kind }
}

// URLã‹ã‚‰ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆGitHub Rawãªã©ï¼‰
async function uploadFromUrl(url, folderId, fileName){
  const body = { url, folderId, fileName };
  const r = await fetch(EP_UPLOAD_FROM_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });
  const j = await r.json().catch(()=>({}));
  return { ok:r.ok, status:r.status, body:j };
}

// ===== ä¿å­˜ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ =====
async function doUpload(){
  if(!pickedFolderId){ alert("ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸ã‚“ã§ãã ã•ã„"); return; }

  // å…¥åŠ›ã•ã‚ŒãŸãƒ™ãƒ¼ã‚¹å
  const emlBase  = ($("emlBase").value  || "Report").trim();
  const attachBase = ($("xlsxBase").value || "Attachment").trim();
  const emlName = emlBase.toLowerCase().endsWith(".eml") ? emlBase : (emlBase + ".eml");

  // æœŸå¾…ãƒ•ãƒ©ã‚°
  const want_eml  = Boolean(T_EML || TICKET_SINGLE);
  const want_msg  = Boolean(T_MSG);

  if(!want_eml && !want_msg && !T_XLSX){
    alert("ä¿å­˜ã™ã‚‹ãƒã‚±ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆticket_eml / ticket_msg / ticket_xlsx ã®ã„ãšã‚Œã‹ãŒå¿…è¦ï¼‰");
    return;
  }

  try {
    // 1) ã¾ãš .msg ã®æœ€åˆã®æ·»ä»˜ï¼ˆExcel>PDF>Wordï¼‰ã‚’ãƒã‚±ãƒƒãƒˆåŒ–ã—ã¦ç¨®é¡ã‚’åˆ¤å®š
    let kind = null;
    let attTicket = null;
    let attOrigName = null;

    if (T_MSG) {
      try{
        log("â†’ msg-to-attachment-ticket");
        const j = await createAttachmentTicketFromMsg(T_MSG, attachBase);
        attTicket = j.ticket;
        attOrigName = (j.fileName || "").trim();
        kind = j.kind; // 'excel' | 'pdf' | 'word'
        log("attachment ticket ok: " + attOrigName + " (kind=" + kind + ")");
      }catch(e){
        log("âš ï¸ æ·»ä»˜æ¤œå‡ºãªã—ï¼ˆã¾ãŸã¯å¯¾è±¡å¤–ï¼‰: " + e.message);
      }
    }

    // 2) .eml ä¿å­˜
    if (want_eml) {
      const t = T_EML || TICKET_SINGLE;
      log("â†’ eml upload as: " + emlName);
      const r = await uploadOne(EP_UPLOAD_ORG, t, emlName);
      log(r.ok ? "âœ… AIä½œæˆæœ¬æ–‡ä¿å­˜æˆåŠŸ" : "âŒ eml " + JSON.stringify(r.body));
    }

    // 3) .msg åŸæ–‡ä¿å­˜
    if (want_msg) {
      log("â†’ msg upload (original name)");
      const r = await uploadOne(EP_UPLOAD_ORG, T_MSG, null);
      log(r.ok ? "âœ… BPã•ã‚“ã‹ã‚‰ã®ãƒ¡ãƒ¼ãƒ«ä¿å­˜æˆåŠŸ" : "âŒ msg " + JSON.stringify(r.body));
    }

    // 4) æ·»ä»˜ä¿å­˜ã®åˆ†å²
    if (attTicket && kind) {
      // æ·»ä»˜åã¯ãƒã‚±ãƒƒãƒˆç”Ÿæˆæ™‚ã«æ‹¡å¼µå­ã‚’åˆã‚ã›ã¦ã‚ã‚‹ã®ã§ã€ãã®ã¾ã¾ä½¿ã†
      log("â†’ attachment upload as: " + attOrigName);
      const r = await uploadOne(EP_UPLOAD_ORG, attTicket, attOrigName);
      log(r.ok ? "âœ… æ·»ä»˜ä¿å­˜æˆåŠŸ ("+kind+")" : "âŒ attachment " + JSON.stringify(r.body));

      // Excel ã®ã¨ãã ã‘ GitHub Raw ã‚’è¿½åŠ ä¿å­˜ï¼ˆå¾“æ¥ã®4ç‚¹ä¿å­˜ã‚’è¸è¥²ï¼‰
      if (kind === "excel") {
        try{
          log("â†’ upload-from-url: " + GITHUB_RAW_URL);
          const r4 = await uploadFromUrl(GITHUB_RAW_URL, pickedFolderId, GITHUB_SAVE_NAME);
          if (r4.ok && r4.body && r4.body.ok) {
            log("âœ… GitHubãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜æˆåŠŸ: " + (r4.body.name || GITHUB_SAVE_NAME));
          } else {
            log("âš ï¸ GitHubä¿å­˜å¤±æ•—: " + JSON.stringify(r4.body));
          }
        }catch(e){
          log("âš ï¸ upload-from-url ã‚¨ãƒ©ãƒ¼: " + e.message);
        }
      }
    } else if (T_XLSX) {
      // ç›´æ¥ xlsx ãƒã‚±ãƒƒãƒˆãŒæ¥ã¦ã„ã‚‹å ´åˆï¼ˆå¾“æ¥äº’æ›ï¼‰
      const xlsxOrigFileName = "attachment.xlsx";
      log("â†’ xlsx upload as: " + (attachBase + ".xlsx"));
      const r = await uploadOne(EP_UPLOAD_ORG, T_XLSX, attachBase + ".xlsx");
      log(r.ok ? "âœ… æ·»ä»˜Excelä¿å­˜æˆåŠŸ" : "âŒ xlsx " + JSON.stringify(r.body));

      // å¾“æ¥ã®4ç‚¹ä¿å­˜ï¼ˆGitHubï¼‰ã‚‚å®Ÿæ–½
      try{
        log("â†’ upload-from-url: " + GITHUB_RAW_URL);
        const r4 = await uploadFromUrl(GITHUB_RAW_URL, pickedFolderId, GITHUB_SAVE_NAME);
        if (r4.ok && r4.body && r4.body.ok) {
          log("âœ… GitHubãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜æˆåŠŸ: " + (r4.body.name || GITHUB_SAVE_NAME));
        } else {
          log("âš ï¸ GitHubä¿å­˜å¤±æ•—: " + JSON.stringify(r4.body));
        }
      }catch(e){
        log("âš ï¸ upload-from-url ã‚¨ãƒ©ãƒ¼: " + e.message);
      }
    } else {
      log("â„¹ï¸ æ·»ä»˜ä¿å­˜ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå¯¾è±¡æ·»ä»˜ãªã—ï¼‰");
    }

    $("pickedHint").textContent = "ä¿å­˜å…ˆ: " + (pickedFolderName || pickedFolderId);
  } catch(e){
    log("âŒ " + e.message);
  }
}

// ãƒ”ãƒƒã‚«ãƒ¼æ“ä½œ
$("openPicker").onclick=openPicker;
$("pickerSave").onclick=async ()=>{
  if(!pickedFolderId){ return; }
  closePicker();
  await doUpload(); // ãƒ”ãƒƒã‚«ãƒ¼å†…ã®ã€Œä¿å­˜ã€ã§å³ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
};
</script>
