<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>OneDrive Picker Dialog (Aæ¡ˆï¼‹æˆ»ã‚‹ä¿®æ­£)</title>
<style>
  :root { --brand:#0078d4; --bg:#f8f9fa; --muted:#e9ecef; --text:#222; }
  body { font-family: "Segoe UI", system-ui, -apple-system, sans-serif; background: var(--bg); margin:0; color:var(--text); }
  header { background: var(--brand); color:#fff; padding:10px 16px; display:flex; align-items:center; gap:8px; }
  header h1 { font-size:16px; margin:0; font-weight:600; }
  .toolbar { padding:8px 16px; background:#fff; border-bottom:1px solid #dde1e6; display:flex; gap:8px; align-items:center; }
  .toolbar button { border:none; border-radius:6px; padding:8px 12px; background:var(--brand); color:#fff; cursor:pointer; }
  .toolbar button.secondary { background:#e5f1fb; color:#0b5cab; }
  .toolbar button:disabled { opacity:.5; cursor:not-allowed; }
  #crumbsWrap { padding:8px 16px; background: var(--muted); border-bottom:1px solid #dde1e6; display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
  #crumbs .crumb { cursor:pointer; color: var(--brand); }
  #crumbs .crumb::after { content:" / "; color:#888; }
  #crumbs .crumb:last-child::after { content:""; }
  #searchBox { display:none; padding:8px 16px; background:#fff; border-bottom:1px solid #dde1e6; display:flex; gap:8px; }
  #searchInput { flex:1; padding:8px; border:1px solid #c8ccd1; border-radius:6px; }
  #fileList { padding:16px; display:grid; grid-template-columns: 1fr; gap:8px; }
  .file-item { padding:10px 12px; background:#fff; border:1px solid #dcdfe4; border-radius:8px; cursor:pointer; }
  .file-item:hover { background:#f4f9ff; }
  .file-item.selected { border-color: var(--brand); background:#e7f1fb; }
  footer { background:#fff; border-top:1px solid #dde1e6; padding:10px 16px; display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
  #currentPath { color:#555; font-size:12px; }
  .right { display:flex; gap:8px; }
  .hint { font-size:12px; color:#444; background:#eef5ff; padding:4px 8px; border-radius:999px; }
</style>
</head>
<body>
  <header>
    <h1>ä¿å­˜å…ˆã‚’é¸æŠ</h1>
  </header>

  <div class="toolbar">
    <button id="btnBack" class="secondary" title="ç›´å‰ã«è¡¨ç¤ºã—ã¦ã„ãŸå ´æ‰€ã¸æˆ»ã‚‹">â† æˆ»ã‚‹</button>
    <button id="btnUp" class="secondary" title="è¦ªãƒ•ã‚©ãƒ«ãƒ€ã¸ç§»å‹•">â†‘ ä¸Šã¸</button>
    <button id="searchToggle" class="secondary" title="ãƒ•ã‚©ãƒ«ãƒ€åã‚’æ¤œç´¢">æ¤œç´¢</button>
  </div>

  <div id="crumbsWrap">
    <div id="crumbs"></div>
  </div>

  <div id="searchBox">
    <input id="searchInput" type="text" placeholder="ãƒ•ã‚©ãƒ«ãƒ€åã‚’æ¤œç´¢..." />
    <button id="clearSearch" class="secondary" title="æ¤œç´¢ã‚’ã‚¯ãƒªã‚¢">âœ• ã‚¯ãƒªã‚¢</button>
  </div>

  <div id="fileList"></div>

  <footer>
    <div>
      <div id="currentPath">ãƒ«ãƒ¼ãƒˆ</div>
      <div class="hint" id="hintSaveTo">ä¿å­˜å…ˆï¼šç¾åœ¨ã®ãƒ•ã‚©ãƒ«ãƒ€</div>
    </div>
    <div class="right">
      <button id="saveBtn">ä¿å­˜</button>
    </div>
  </footer>

<script>
const $ = (id) => document.getElementById(id);

// --------- çŠ¶æ…‹ ---------
let breadcrumb = [{ id: "root", name: "ãƒ«ãƒ¼ãƒˆ" }]; // ä»®æƒ³ãƒ«ãƒ¼ãƒˆ
let currentId = "root";
let currentList = [];
let pickedFolderId = null;
let filterWord = "";
let navStack = []; // æˆ»ã‚‹ç”¨ï¼šç›´å‰çŠ¶æ…‹ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ç©ã‚€
let leftVirtualRoot = false; // ä»®æƒ³ãƒ«ãƒ¼ãƒˆã‹ã‚‰å¤–ã¸å‡ºãŸã‹

// --------- ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ä½œæˆï¼ˆå®Ÿéš›ã¯APIã§ç½®ãæ›ãˆï¼‰ ---------
function mockListFor(id) {
  // idãƒ™ãƒ¼ã‚¹ã§ç–‘ä¼¼çš„ã«ä¸­èº«ã‚’å¤‰ãˆã‚‹
  const base = id.replace(/[^A-Z0-9]/gi,"").slice(-2).toUpperCase() || "RT";
  return [
    { id: id + "-A", name: base + "_è³‡æ–™",  type: "folder" },
    { id: id + "-B", name: base + "_å ±å‘Š",  type: "folder" },
    { id: id + "-C", name: base + "_ç”»åƒ",  type: "folder" },
  ];
}

// --------- å…±é€šï¼šã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ ---------
function snapshot() {
  // æ·±ã„ã‚³ãƒ”ãƒ¼ï¼ˆåå‰é…åˆ—ã¯æµ…ã„ã®ã§OKï¼‰
  return {
    currentId,
    breadcrumb: breadcrumb.map(c => ({...c})),
    filterWord,
    pickedFolderId
  };
}
function restore(state) {
  currentId = state.currentId;
  breadcrumb = state.breadcrumb.map(c => ({...c}));
  filterWord = state.filterWord;
  pickedFolderId = state.pickedFolderId;
}

// --------- ãƒ­ãƒ¼ãƒ‰ ---------
async function loadFolder(id, keepFilter=false, reason="") {
  currentId = id;

  // æ¤œç´¢èªã®ã‚¯ãƒªã‚¢ï¼ˆéšå±¤ç§»å‹•æ™‚ï¼‰
  if (!keepFilter && reason !== "reload") {
    filterWord = "";
    $("searchInput").value = "";
  }

  // å®Ÿãƒ‡ãƒ¼ã‚¿å–å¾—ã®ä»£ã‚ã‚Šã«ãƒ¢ãƒƒã‚¯
  currentList = mockListFor(id);

  // é¸æŠã¯åŸºæœ¬ã‚¯ãƒªã‚¢ï¼ˆèª¤ä¿å­˜é˜²æ­¢ï¼‰
  pickedFolderId = null;

  renderList();
  updateBreadcrumb();
  updateButtons();
  updateSaveHint();
}

// --------- ä¸€æ®µä¸‹ã¸ï¼ˆå…¥ã‚‹ï¼‰ ---------
function enterFolder(folder) {
  navStack.push(snapshot());
  breadcrumb.push({ id: folder.id, name: folder.name });
  loadFolder(folder.id, false, "enter");
}

// --------- ä¸€æ®µä¸Šã¸ï¼ˆè¦ªã¸ï¼‰ ---------
function goUp() {
  // ä»®æƒ³ãƒ«ãƒ¼ãƒˆå†…ã«ã„ã‚‹å ´åˆ
  if (breadcrumb.length > 1) {
    navStack.push(snapshot());
    breadcrumb.pop();
    const parentId = breadcrumb[breadcrumb.length - 1].id;
    loadFolder(parentId, false, "up");
    return;
  }

  // ã“ã“ã‹ã‚‰ä»®æƒ³ãƒ«ãƒ¼ãƒˆå¤–ã¸å‡ºã‚‹
  if (!leftVirtualRoot) {
    const ok = confirm("æŒ‡å®šã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆã®å¤–ã«ç§»å‹•ã—ã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ");
    if (!ok) return;
    leftVirtualRoot = true;
  }

  // ãƒ«ãƒ¼ãƒˆã®ã•ã‚‰ã«ä¸Šï¼ãƒ‰ãƒ©ã‚¤ãƒ–ç›´ä¸‹ã¸
  // æœ€ä¸Šä½ãŒã€Œãƒ‰ãƒ©ã‚¤ãƒ–ã€ã§ã€ãã‚Œä»¥ä¸Šã¯ä¸ŠãŒã‚Œãªã„æƒ³å®š
  if (breadcrumb.length === 1 && breadcrumb[0].id === "root") {
    navStack.push(snapshot());
    breadcrumb = [{ id: "drive", name: "ãƒ‰ãƒ©ã‚¤ãƒ–" }];
    loadFolder("drive", false, "up-out");
  } else if (breadcrumb.length > 0 && breadcrumb[0].id === "drive") {
    // ã™ã§ã«ãƒ‰ãƒ©ã‚¤ãƒ–ç›´ä¸‹ â†’ ã“ã‚Œä»¥ä¸Šã¯ä¸ŠãŒã‚Œãªã„
    // ä½•ã‚‚ã—ãªã„
  }
}

// --------- ç›´å‰ã«è¡¨ç¤ºã—ã¦ã„ãŸå ´æ‰€ã¸æˆ»ã‚‹ï¼ˆå±¥æ­´ï¼‰ ---------
function goBack() {
  if (navStack.length === 0) return;
  const state = navStack.pop();
  restore(state);
  renderList();
  updateBreadcrumb();
  updateButtons();
  updateSaveHint();
}

// --------- ãƒ‘ãƒ³ããšæ›´æ–°ï¼ˆå¸¸ã«å†è¨ˆç®—æç”»ã€appendã—ãªã„ï¼‰ ---------
function updateBreadcrumb() {
  const wrap = $("crumbs");
  wrap.innerHTML = "";

  breadcrumb.forEach((c, i) => {
    const s = document.createElement("span");
    s.className = "crumb";
    s.textContent = c.name;
    s.onclick = () => {
      // ãƒ‘ãƒ³ããšã‚¯ãƒªãƒƒã‚¯ã‚‚å±¥æ­´ã«ç©ã‚€ï¼ˆBackã§æˆ»ã‚Œã‚‹ã‚ˆã†ã«ï¼‰
      navStack.push(snapshot());
      breadcrumb = breadcrumb.slice(0, i + 1);
      loadFolder(c.id, false, "crumb");
    };
    wrap.appendChild(s);
  });

  $("currentPath").textContent = breadcrumb.map(c => c.name).join(" / ");
}

// --------- ãƒªã‚¹ãƒˆæç”» ---------
function renderList() {
  const list = $("fileList");
  list.innerHTML = "";

  const filtered = filterWord
    ? currentList.filter(f => f.name.includes(filterWord))
    : currentList;

  filtered.forEach(f => {
    const div = document.createElement("div");
    div.className = "file-item" + (f.id === pickedFolderId ? " selected" : "");
    div.textContent = "ğŸ“‚ " + f.name;

    div.onclick = (e) => {
      if (e.detail === 2) {
        // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ï¼šå…¥ã‚‹
        enterFolder(f);
      } else {
        // ã‚·ãƒ³ã‚°ãƒ«ï¼šé¸æŠ
        pickedFolderId = f.id;
        updateSaveHint();
        renderList();
      }
    };

    list.appendChild(div);
  });
}

// --------- ãƒœã‚¿ãƒ³çŠ¶æ…‹ ---------
function updateButtons() {
  // æˆ»ã‚‹ï¼šå±¥æ­´ãŒç©ºãªã‚‰ç„¡åŠ¹
  $("btnBack").disabled = navStack.length === 0;

  // ä¸Šã¸ï¼šãƒ‰ãƒ©ã‚¤ãƒ–ãŒå…ˆé ­ãªã‚‰ç„¡åŠ¹ã€ãã‚Œä»¥å¤–ã¯æœ‰åŠ¹
  const atDriveTop = (breadcrumb.length === 1 && breadcrumb[0].id === "drive");
  $("btnUp").disabled = atDriveTop;
}

// --------- æ¤œç´¢ UI ---------
$("searchToggle").onclick = () => {
  const box = $("searchBox");
  const isOpen = box.style.display === "flex";
  box.style.display = isOpen ? "none" : "flex";
  if (!isOpen) $("searchInput").focus();
};
$("searchInput").oninput = (e) => {
  filterWord = e.target.value;
  renderList();
};
$("clearSearch").onclick = () => {
  filterWord = "";
  $("searchInput").value = "";
  renderList();
};

// --------- ä¿å­˜ ---------
$("saveBtn").onclick = () => {
  const folderId = pickedFolderId || currentId;
  const folderName = pickedFolderId
    ? (currentList.find(f => f.id === pickedFolderId)?.name || "(ä¸æ˜)")
    : breadcrumb[breadcrumb.length - 1].name;
  alert(`ãƒ•ã‚©ãƒ«ãƒ€ã€${folderName}ã€ã«ä¿å­˜ã—ã¾ã™ (id=${folderId})`);
};

function updateSaveHint() {
  const hint = $("hintSaveTo");
  if (pickedFolderId) {
    const name = currentList.find(f => f.id === pickedFolderId)?.name || "(ä¸æ˜)";
    hint.textContent = `ä¿å­˜å…ˆï¼š${name}ï¼ˆé¸æŠãƒ•ã‚©ãƒ«ãƒ€ï¼‰`;
  } else {
    hint.textContent = `ä¿å­˜å…ˆï¼š${breadcrumb[breadcrumb.length - 1].name}ï¼ˆç¾åœ¨ã®ãƒ•ã‚©ãƒ«ãƒ€ï¼‰`;
  }
}

// --------- ã‚¤ãƒ™ãƒ³ãƒˆå‰²ã‚Šå½“ã¦ ---------
$("btnUp").onclick = goUp;
$("btnBack").onclick = goBack;

// --------- åˆæœŸåŒ– ---------
loadFolder("root", true, "init");
</script>
</body>
</html>
