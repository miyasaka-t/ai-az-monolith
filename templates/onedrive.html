<!doctype html>
<meta charset="utf-8" />
<title>OneDrive ä¿å­˜ï¼ˆé¸æŠã—ãŸã‚‚ã®ã‚’UIå…¥åŠ›åã§ä¿å­˜ï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{ --fg:#1f2937; --muted:#6b7280; --line:#e5e7eb; --bg:#fff; --primary:#0b5; }
  body{font:13px/1.5 ui-sans-serif,system-ui,Segoe UI,Helvetica,Arial;
       color:var(--fg); max-width:900px; margin:20px auto; padding:0 10px;}
  h1{font-size:18px;margin:0 0 8px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0}
  .col{display:flex;flex-direction:column;gap:6px;min-width:260px;flex:1}
  label.small{font-size:12px;color:var(--muted)}
  input[type=text]{flex:1;min-width:240px;padding:8px 10px;border:1px solid var(--line);border-radius:10px}
  button{padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
  button:disabled{opacity:.55;cursor:not-allowed}
  .pill{padding:4px 8px;border:1px solid #e8e8ff;background:#f7f7ff;border-radius:999px}
  .badge{padding:2px 8px;border-radius:999px;background:#eef;color:#224;font-weight:600}
  .muted{color:var(--muted)}
  #log{white-space:pre-wrap;background:#fafafa;border:1px solid #eee;padding:10px;min-height:140px}

  .picker-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:9999}
  .picker-panel{width:min(560px,92vw);background:var(--bg);border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,.20);overflow:hidden}
  .picker-head{display:flex;align-items:center;gap:6px;padding:8px 10px;border-bottom:1px solid var(--line)}
  .picker-title{font-weight:700;margin-right:auto}
  .picker-toolbar{display:flex;gap:6px}
  .picker-body{padding:0;max-height:60vh;overflow:auto}
  .picker-breadcrumb{display:flex;gap:4px;align-items:center;flex-wrap:wrap;padding:6px 10px;border-bottom:1px solid var(--line);background:#fafafa}
  .crumb{color:#2563eb;cursor:pointer}
  .crumb::after{content:"â€º";margin:0 4px;color:#9ca3af}
  .crumb:last-child{font-weight:700;color:var(--fg)}
  .crumb:last-child::after{content:""}
  .list{width:100%;padding:8px}
  .th,.tr{display:grid;grid-template-columns: 1fr 168px;gap:8px;align-items:center}
  .th{padding:0 6px 6px;color:var(--muted);font-weight:600;border-bottom:1px solid var(--line)}
  .tr{padding:2px 6px}
  .rowbox{display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:10px;padding:6px 8px;min-height:34px}
  .tr:hover .rowbox{background:#f8faff}
  .name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .act{display:inline-flex;gap:6px;justify-content:flex-end;align-items:center}
  .act > button{padding:6px 8px;line-height:1;border-radius:8px}
  .ok{background:var(--primary);color:#fff;border-color:var(--primary)}
  .picker-foot{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-top:1px solid var(--line)}
  .path{font-family:ui-monospace,Menlo,Consolas,monospace;color:#555;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:62%}

  .vertical{flex-direction:column;align-items:flex-start;gap:8px}
  .chk{display:flex;align-items:center;gap:8px}
  #btnUp { display: none !important; } /* è¦ªã¸ãƒœã‚¿ãƒ³éè¡¨ç¤ºï¼ˆå¿…è¦ãªã‚‰å¤–ã—ã¦OKï¼‰ */
</style>

<h1>OneDrive ä¿å­˜ <span class="badge">çµ„ç¹”ãƒ¢ãƒ¼ãƒ‰</span></h1>
<p class="muted">ãƒã‚§ãƒƒã‚¯ã—ãŸã‚‚ã®ã ã‘ä¿å­˜ã€‚ãƒ•ã‚¡ã‚¤ãƒ«åã¯ä¸‹ã®å…¥åŠ›å€¤ã§ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆæ‹¡å¼µå­ã¯è‡ªå‹•ä»˜ä¸ï¼‰ã€‚</p>

<div class="row">
  <div class="col">
    <label class="small">AIä½œæˆæœ¬æ–‡ï¼ˆ.emlï¼‰ã®ãƒ™ãƒ¼ã‚¹å</label>
    <input id="emlBase" type="text" placeholder="Report_AImade">
  </div>
  <div class="col">
    <label class="small">æ·»ä»˜Excelã®ãƒ™ãƒ¼ã‚¹å</label>
    <input id="xlsxBase" type="text" placeholder="Report_skillsheet_yyyymmdd">
  </div>
</div>

<div class="row vertical">
  <div class="chk">
    <label><input type="checkbox" id="cb_eml"> AIä½œæˆæœ¬æ–‡.eml</label>
    <span id="nm_eml" class="muted"></span>
  </div>
  <div class="chk">
    <label><input type="checkbox" id="cb_xlsx"> æ·»ä»˜Excelã‚¹ã‚­ãƒ«ã‚·ãƒ¼ãƒˆ</label>
    <span id="nm_xlsx" class="muted"></span>
  </div>
  <div class="chk">
    <label><input type="checkbox" id="cb_msg"> BPã•ã‚“ã‹ã‚‰ã®ãƒ¡ãƒ¼ãƒ«.msg</label>
    <span id="nm_msg" class="muted"></span>
  </div>
</div>

<div class="row">
  <button id="pickLocal">ğŸ“ ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸ã¶</button>
  <span id="pickedHint" class="pill"></span>
</div>
<div class="row"><button id="upload" disabled>â¬† é¸æŠã—ãŸã‚‚ã®ã‚’ä¿å­˜</button></div>

<h3>ãƒ­ã‚°</h3>
<pre id="log"></pre>

<!-- è‡ªå‰ãƒ•ã‚©ãƒ«ãƒ€ãƒ”ãƒƒã‚«ãƒ¼ -->
<div id="picker" class="picker-backdrop" style="display:none" role="dialog" aria-modal="true">
  <div class="picker-panel">
    <div class="picker-head">
      <div class="picker-title">ä¿å­˜å…ˆã‚’é¸æŠ</div>
      <div class="picker-toolbar">
        <button id="btnBack">â† æˆ»ã‚‹</button>
        <button id="btnUp">â†‘ è¦ªã¸</button>
        <button id="btnNewFolder">ï¼‹ æ–°è¦ãƒ•ã‚©ãƒ«ãƒ€</button>
        <button id="btnReload">âŸ³ æ›´æ–°</button>
      </div>
    </div>
    <div class="picker-breadcrumb" id="crumbs"></div>
    <div class="picker-body">
      <div class="th"><div>åå‰</div><div style="text-align:right">æ“ä½œ</div></div>
      <div id="list" class="list"></div>
    </div>
    <div class="picker-foot">
      <div class="path" id="currentPath">/</div>
      <div>
        <button id="pickerCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="pickerOk" class="ok" disabled>ã“ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ</button>
      </div>
    </div>
  </div>
</div>

<script>
const $ = (id)=>document.getElementById(id);
const log = (m)=>{ $("log").textContent += m + "\n"; };

// ===== Query =====
const q = new URLSearchParams(location.search);
const T_EML   = (q.get("ticket_eml")  || "").trim();
const T_XLXS_RAW = (q.get("ticket_xlsx") || "").trim();   // è¤‡æ•°å¯ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
const T_MSG   = (q.get("ticket_msg")  || "").trim();
const INIT_EML  = (q.get("eml")   || "Report_AImade").trim();
const INIT_XLSX = (q.get("excel") || "Report_skillsheet").trim();

$("emlBase").value  = INIT_EML;
$("xlsxBase").value = INIT_XLSX;

// XLSX è¤‡æ•°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š â†’ é…åˆ—ï¼‰
const T_XLSX_LIST = T_XLXS_RAW
  ? T_XLXS_RAW.split(",").map(s => s.trim()).filter(Boolean)
  : [];

// ===== Endpoints (monolith; relative path) =====
const EP_PEEK             = "/tickets/peek";
const EP_UPLOAD_ORG       = "/api/upload";
const EP_LIST_FOLDERS     = "/api/drive/folders";
const EP_CREATE_FOLDER    = "/api/drive/create-folder";

// åˆæœŸãƒã‚§ãƒƒã‚¯è¡¨ç¤º
(function init(){
  if (T_EML){ $("cb_eml").checked = true; $("nm_eml").textContent = "ticket ready"; }
  if (T_XLSX_LIST.length){ $("cb_xlsx").checked = true; $("nm_xlsx").textContent = "tickets: " + T_XLSX_LIST.length; }
  if (T_MSG){ $("cb_msg").checked = true; $("nm_msg").textContent = "ticket ready"; }
})();

// ===== Picker =====
let pickedFolderId=null,pickedFolderName=null,currentId="root",historyStack=[],breadcrumb=[{id:"root",name:"ãƒ«ãƒ¼ãƒˆ"}];

function openPicker(){ pickedFolderId=null;pickedFolderName=null;$("pickerOk").disabled=true;$("picker").style.display="flex";historyStack=[];breadcrumb=[{id:"root",name:"ãƒ«ãƒ¼ãƒˆ"}];loadFolder("root",false,"open");}
function closePicker(){ $("picker").style.display="none"; }

async function loadFolder(id,pushHistory=true,from="enter"){
  $("list").innerHTML="";$("pickerOk").disabled=true;
  try{
    const r=await fetch(EP_LIST_FOLDERS+"?parentId="+encodeURIComponent(id||"root"));
    const j=await r.json();
    if(!r.ok) throw new Error(j.error||r.statusText);
    if(pushHistory&&currentId&&from!=="back") historyStack.push(currentId);
    currentId=id||"root";updateBreadcrumb(j.parent,id);renderList(j.folders||[]);
    $("currentPath").textContent=breadcrumb.map(c=>c.name).join("/")||"/";
  }catch(e){ log("âŒ folder load: "+e.message); }
}
function updateBreadcrumb(parentMeta,id){
  if((id||"root")==="root") breadcrumb=[{id:"root",name:"ãƒ«ãƒ¼ãƒˆ"}];
  else{breadcrumb.push({id,name:(parentMeta&&parentMeta.name)||"(ä¸æ˜)"});}
  $("crumbs").innerHTML="";
  breadcrumb.forEach((c,i)=>{
    const s=document.createElement("span");
    s.className="crumb"; s.textContent=c.name;
    s.onclick=()=>{breadcrumb=breadcrumb.slice(0,i+1);loadFolder(c.id,false,"crumb");};
    $("crumbs").appendChild(s);
  });
}
function renderList(folders){
  const list=$("list");
  if(!folders.length){list.innerHTML="<div style='padding:10px'>ï¼ˆç©ºï¼‰</div>";return;}
  folders.forEach(f=>{
    const row=document.createElement("div");row.className="tr";
    const left=document.createElement("div");left.className="rowbox";left.textContent="ğŸ“ "+f.name;left.ondblclick=()=>enterFolder(f.id,f.name);
    const right=document.createElement("div");right.className="act";
    const bOpen=document.createElement("button");bOpen.textContent="é–‹ã";bOpen.onclick=()=>enterFolder(f.id,f.name);
    const bChoose=document.createElement("button");bChoose.textContent="ã“ã“ã«ä¿å­˜";bChoose.onclick=()=>chooseHere(f.id,f.name);
    right.appendChild(bOpen);right.appendChild(bChoose);
    row.appendChild(left);row.appendChild(right);list.appendChild(row);
  });
}
function enterFolder(id,name){breadcrumb.push({id,name});loadFolder(id,true,"enter");}
function chooseHere(id,name){pickedFolderId=id;pickedFolderName=name;$("pickedHint").textContent="ä¿å­˜å…ˆ: "+name;$("pickerOk").disabled=false;}
$("pickerOk").onclick=function(){ if(pickedFolderId){ closePicker(); $("upload").disabled=false; } }
$("pickerCancel").onclick=function(){ closePicker(); }
$("btnBack").onclick=function(){ if(historyStack.length){ const prev=historyStack.pop(); breadcrumb.pop(); loadFolder(prev,false,"back"); } }
$("btnReload").onclick=function(){ loadFolder(currentId,false,"reload"); }
$("btnNewFolder").onclick=async function(){
  const nm=prompt("æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€å"); if(!nm) return;
  try{
    const r=await fetch(EP_CREATE_FOLDER,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({parentId:currentId,name:nm})});
    const j=await r.json();
    if(!r.ok) throw new Error(j.error||r.statusText);
    log("ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ: "+j.name);
    loadFolder(currentId,false,"reload");
  }catch(e){ log("âŒ create-folder: "+e.message); }
};

$("pickLocal").onclick=openPicker;

// ===== Helper: ãƒã‚±ãƒƒãƒˆã®æ‹¡å¼µå­ã‚’ peek ã‹ã‚‰å–å¾— =====
async function getExtFromTicket(ticket){
  try{
    const r = await fetch(EP_PEEK + "?ticket=" + encodeURIComponent(ticket));
    const j = await r.json();
    if (!r.ok) return null;
    const name = (j.fileName || "").trim();
    const m = name.lastIndexOf(".");
    if (m >= 0) return name.slice(m+1);
  }catch(e){}
  return null;
}

// ===== Uploadï¼ˆUIå…¥åŠ›åã§ä¿å­˜ï¼‰ =====
$("upload").onclick = async function () {
  if (!pickedFolderId) { alert("ä¿å­˜å…ˆæœªé¸æŠ"); return; }

  const doEML  = $("cb_eml").checked  && !!T_EML;
  const doXLSX = $("cb_xlsx").checked && T_XLSX_LIST.length > 0;
  const doMSG  = $("cb_msg").checked  && !!T_MSG;

  const emlBase  = ($("emlBase").value  || "Report_AImade").trim();
  const xlsxBase = ($("xlsxBase").value || "Report_skillsheet").trim();

  if (!doEML && !doXLSX && !doMSG){
    alert("ä¿å­˜å¯¾è±¡ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“"); return;
  }

  const tasks = [];
  const pushUpload = (ticket, folderId, fileName) => {
    const fd = new FormData();
    fd.append("ticket", ticket);
    fd.append("folderId", folderId);
    if (fileName) fd.append("fileName", fileName); // â† UIå…¥åŠ›åã§ä¸Šæ›¸ãä¿å­˜
    tasks.push(fetch(EP_UPLOAD_ORG, { method: "POST", body: fd }));
  };

  try {
    log("ğŸš€ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹");

    // 1) EML â†’ <emlBase>.eml
    if (doEML) {
      const saveName = `${emlBase}.eml`;
      log("EML ä¿å­˜äºˆå®š: " + saveName);
      pushUpload(T_EML, pickedFolderId, saveName);
    }

    // 2) XLSX/CSVï¼ˆè¤‡æ•°å¯ï¼‰ â†’ <xlsxBase>.<ext> / <xlsxBase>_2.<ext> / ...
    if (doXLSX) {
      let idx = 1;
      for (const tx of T_XLSX_LIST) {
        const ext = (await getExtFromTicket(tx)) || "xlsx";
        const suffix = (idx === 1 ? "" : `_${idx}`);
        const saveName = `${xlsxBase}${suffix}.${ext}`;
        log("XLSX/CSV ä¿å­˜äºˆå®š: " + saveName);
        pushUpload(tx, pickedFolderId, saveName);
        idx++;
      }
    }

    // 3) MSG åŸæœ¬ â†’ <emlBase>_mail.msg
    if (doMSG) {
      const saveName = `${emlBase}_mail.msg`;
      log("MSG ä¿å­˜äºˆå®š: " + saveName);
      pushUpload(T_MSG, pickedFolderId, saveName);
    }

    // å®Ÿè¡Œ
    const rs = await Promise.all(tasks);
    for (const r of rs) {
      const j = await r.json();
      if (!r.ok) throw new Error(j.error || r.statusText);
      log("âœ… ä¿å­˜: " + (j.name || "(no name)") + " " + (j.webUrl || ""));
    }
    log("ğŸ‰ å®Œäº†");
  } catch (e) {
    log("âŒ upload: " + e.message);
  }
};
</script>
